## Dockerfile 多阶段构建
在 Dockerfile 中使用多阶段构建可以帮助优化最终镜像的大小和安全性，通过构建过程中的不同阶段来管理不同的任务和资源。下面是您的 Dockerfile 中提到的各个阶段（`base`、`packages`、`builder`、`production`）之间的关系和作用：

### Base 阶段
目的：设置一个共通的基础环境，以供后续的所有阶段使用。这个阶段安装了 Node.js 环境和基础的时区数据（通过安装 `tzdata` 包）。

优点：所有后续阶段都从这个基础环境继承，这样可以避免重复安装相同的基础软件，减少了构建时间和镜像大小。

### Packages 阶段
目的：在独立的阶段中安装应用的依赖。这个阶段利用 `base` 阶段的环境，复制 `package.json` 和 `yarn.lock` 文件，并执行 `yarn install` 命令来安装依赖。

优点：将依赖安装在独立的阶段中可以缓存依赖，除非 `package.json` 或 `yarn.lock` 发生变化，否则 Docker 在构建时可以重用缓存的依赖层，这大大加速了构建过程。

### Builder 阶段
目的：执行应用的构建过程。这个阶段同样基于 `base` 阶段，并从 `packages` 阶段复制安装好的依赖及应用代码，然后运行 `yarn build` 命令来构建应用。

优点：由于此阶段专注于应用的构建，因此可以独立管理构建资源和过程，构建完成后，只需要将构建产物（例如编译后的文件）转移到最终的生产镜像中。

### Production 阶段
目的：设置用于运行应用的生产环境。这一阶段也是基于 `base` 阶段，设置了多个环境变量，并从 `builder` 阶段复制构建产物。此外，安装了 `PM2` 作为进程管理器来管理 Node.js 应用，并设置了容器的启动入口点。

优点：这个阶段产生了最终的生产镜像，仅包含运行应用所必需的文件和设置，没有包括用于构建应用的依赖和工具，从而确保了生产环境的精简和安全。

### 阶段之间的关系
继承性：每个阶段都从 `base` 阶段继承，保证了环境的一致性。

依赖性：`builder` 阶段依赖 `packages` 阶段提供的依赖，`production` 阶段依赖 `builder` 阶段提供的构建产物。

优化性：每个阶段聚焦于特定任务，优化了构建过程和最终镜像的大小。

通过这种方式，Dockerfile 的多阶段构建不仅提高了构建的效率，还确保了镜像的整洁和安全，使得维护和部署都更为便捷和可靠。

                        
> 原文链接：https://blog.csdn.net/ssw_1990/article/details/140336223